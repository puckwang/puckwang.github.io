<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta property="og:title" content=".Net Core 使用 FluentMigrator 遷移資料庫">
<meta property="og:description" content="Fluent Migrator 是一個 .Net 的資料庫遷移 (Migration) 框架套件，提供 Code-First 的方式去管理資料庫結構，並可將其納入專案的版控中。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.puckwang.com/posts/2020/dotcore-use-fluentmigrator/"><meta property="og:image" content="https://blog.puckwang.com/images/og_image.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-06-30T17:59:32+08:00">
<meta property="article:modified_time" content="2021-12-12T06:36:48+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.puckwang.com/images/og_image.png">
<meta name=twitter:title content=".Net Core 使用 FluentMigrator 遷移資料庫">
<meta name=twitter:description content="Fluent Migrator 是一個 .Net 的資料庫遷移 (Migration) 框架套件，提供 Code-First 的方式去管理資料庫結構，並可將其納入專案的版控中。">
<script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script>
<script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4827510547436807",enable_page_level_ads:!0})</script>
<title>
.Net Core 使用 FluentMigrator 遷移資料庫 | Puck's Blog
</title>
<link rel=icon type=image/png href=https://blog.puckwang.com/images/favicon-128x128.png sizes="16x16 32x32 64x64 128x128">
<link rel=canonical href=https://blog.puckwang.com/posts/2020/dotcore-use-fluentmigrator/>
<link href="https://fonts.googleapis.com/css?family=Montserrat|Oswald:400" rel=stylesheet>
<link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css integrity=sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO crossorigin=anonymous>
<link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous>
<link rel=stylesheet href=https://blog.puckwang.com/css/bundle.min.5d5448d1820d6ff5f132cb3fde480cdf60aecc3c374bacdc000c3e1bb275845c.css integrity="sha256-XVRI0YINb/XxMss/3kgM32CuzDw3S6zcAAw+G7J1hFw=">
<link rel=me type=text/html href=//www.facebook.com/puckwang14>
<link rel=me type=text/html href=//twitter.com/puckwang14>
<link rel=me type=text/html href=//github.com/puckwang>
<link rel=me type=text/html href=//linkedin.com/in/puckwang>
<link rel=me type=text/html href="//stackoverflow.com/users/7699156/puckwang?tab=profile">
<link rel=me type=text/html href=//g.dev/puckwang>
<link rel=alternate type=application/rss+xml href=https://blog.puckwang.com/index.xml>
<meta charset=utf-8>
<meta name=author content="Puck Wang">
<meta name=copyright content="Copyright © 2017-2024, Puck Wang; all rights reserved.">
<meta name=description content="Fluent Migrator 是一個 .Net 的資料庫遷移 (Migration) 框架套件，提供 Code-First 的方式去管理資料庫結構，並可將其納入專案的版控中。">
<script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({'gtm.start':(new Date).getTime(),event:'gtm.js'});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!='dataLayer'?'&l='+a:'';c.async=!0,c.src='https://www.googletagmanager.com/gtm.js?id='+g+h,f.parentNode.insertBefore(c,f)})(window,document,'script','dataLayer','GTM-T7955DN')</script>
<script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":".Net Core 使用 FluentMigrator 遷移資料庫","headline":".Net Core 使用 FluentMigrator 遷移資料庫","alternativeHeadline":"","description":"Fluent Migrator 是一個 .Net 的資料庫遷移 (Migration) 框架套件，提供 Code-First 的方式去管理資料庫結構，並可將其納入專案的版控中。","inLanguage":"zh-TW","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.puckwang.com\/posts\/2020\/dotcore-use-fluentmigrator\/"},"author":{"@type":"Person","name":"Puck Wang","url":"https:\/\/blog.puckwang.com\/about\/"},"creator":{"@type":"Person","name":"Puck Wang"},"accountablePerson":{"@type":"Person","name":"Puck Wang"},"copyrightHolder":"Puck\u0027s Blog","copyrightYear":"2020","dateCreated":"2020-06-30T17:59:32.00Z","datePublished":"2020-06-30T17:59:32.00Z","dateModified":"2021-12-12T06:36:48.00Z","publisher":{"@type":"Organization","name":"Puck\u0027s Blog","url":"https:\/\/blog.puckwang.com\/","logo":{"@type":"ImageObject","url":"https:\/\/blog.puckwang.com\/images\/favicon-128x128.png","width":"128","height":"128"}},"image":{"@type":"ImageObject","@id":"https:\/\/blog.puckwang.com\/images\/hero-main.jpg","url":"https:\/\/blog.puckwang.com\/images\/hero-main.jpg"},"url":"https:\/\/blog.puckwang.com\/posts\/2020\/dotcore-use-fluentmigrator\/","wordCount":"630","genre":["dotnet",".net-core","套件","database"]}</script>
</head>
<body>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T7955DN" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript>
<nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark py-1 top-nav">
<div class=container>
<a class="navbar-brand pr-2" href=https://blog.puckwang.com/>
<img src=https://blog.puckwang.com/images/logo.png width=40 height=40 alt>
PUCK'S BLOG
</a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#navbarCollapse aria-controls=navbarCollapse aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button>
<div class="navbar-collapse collapse" id=navbarCollapse>
<ul class="navbar-nav mr-auto">
<li class=nav-item>
<a class=nav-link href=https://blog.puckwang.com/>
Home
</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://blog.puckwang.com/about/>
About
</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://blog.puckwang.com/archives/>
Archives
</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://blog.puckwang.com/categories/>
Categories
</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://blog.puckwang.com/tags/>
Tags
</a>
</li>
<li class=nav-item>
<a class=nav-link href=https://blog.puckwang.com/projects/>
MyProjects
</a>
</li>
</ul>
<div class=social-icons>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//www.facebook.com/puckwang14><i class="fab fa-facebook-square"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//twitter.com/puckwang14><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//github.com/puckwang><i class="fab fa-github"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//linkedin.com/in/puckwang><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href="//stackoverflow.com/users/7699156/puckwang?tab=profile"><i class="fab fa-stack-overflow"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//g.dev/puckwang><i class="fab fa-google"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=https://blog.puckwang.com/index.xml><i class="fas fa-rss"></i></a>
</div>
</div>
</div>
</nav>
<style type=text/css>.feature-image{background-image:linear-gradient( rgba(0,0,0,.15),rgba(0,0,0,.15) ),url(https://blog.puckwang.com/images/hero-main.jpg);height:500px}.feature-image-text{margin-top:20px}@media(min-width:1200px){.feature-image{background-position:0 30%}}@media(max-width:768px){.feature-image{height:250px;background-position:0 0}}</style>
<header class=feature-image>
<div class=feature-image-text>
</div>
</header>
<div class=main>
<div class="container mt-4 post">
<h1>.Net Core 使用 FluentMigrator 遷移資料庫</h1>
<div class=mb-3>
<small>
<i class="fas fa-user-edit"></i>&nbsp;作者<strong> Puck Wang</strong>
| <i class="far fa-calendar-alt"></i>&nbsp;建立於 2020-06-30 17:59&nbsp;
| <i class="far fa-calendar-alt"></i>&nbsp;更新於 2021-12-12 06:36&nbsp;
| <i class="fas fa-code-branch"></i>&nbsp;版本 bfd595b&nbsp;
| <i class="fa fa-folder" title=Tags aria-hidden=true></i>&nbsp;分類: <a href=https://blog.puckwang.com/categories/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/>軟體開發</a>
| <i class="fa fa-tags" title=Tags aria-hidden=true></i>&nbsp;標籤: <a href=https://blog.puckwang.com/tags/dotnet/>dotnet</a>, <a href=https://blog.puckwang.com/tags/.net-core/>.net-core</a>, <a href=https://blog.puckwang.com/tags/%E5%A5%97%E4%BB%B6/>套件</a>, <a href=https://blog.puckwang.com/tags/database/>database</a>
</small>
</div>
<div class="share-icons d-flex justify-content-center d-print-none">
<a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.puckwang.com%2fposts%2f2020%2fdotcore-use-fluentmigrator%2f&text=.Net%20Core%20%e4%bd%bf%e7%94%a8%20FluentMigrator%20%e9%81%b7%e7%a7%bb%e8%b3%87%e6%96%99%e5%ba%ab&tw_p=tweetbutton" class=p-2 title="Share on Twitter" target=_blank rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Tweet</small></div>
</a>
<a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.puckwang.com%2fposts%2f2020%2fdotcore-use-fluentmigrator%2f&t=.Net%20Core%20%e4%bd%bf%e7%94%a8%20FluentMigrator%20%e9%81%b7%e7%a7%bb%e8%b3%87%e6%96%99%e5%ba%ab" class=p-2 title="Share on Facebook" target=_blank rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Share</small></div>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.puckwang.com%2fposts%2f2020%2fdotcore-use-fluentmigrator%2f&title=.Net%20Core%20%e4%bd%bf%e7%94%a8%20FluentMigrator%20%e9%81%b7%e7%a7%bb%e8%b3%87%e6%96%99%e5%ba%ab&source=mattbutton.com" class=p-2 title="Share on LinkedIn" target=_blank rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Share</small></div>
</a>
<a href=javascript:window.print() title="Print this article" class=p-2 rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fa fa-print fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Print</small></div>
</a>
</div>
<div class="mt-4 mb-5 main-content">
<p>Fluent Migrator 是一個 <code>.Net</code> 的資料庫遷移 (Migration) 框架套件，其他如 <code>Laravel</code> 及 <code>Ruby on Rails</code> 也有類似的套件。遷移就像是資料庫的版本控制一樣，提供 <code>Code-First</code> 的方式去管理資料庫結構，並可將其納入專案的版控中。</p>
<p>官網：https://fluentmigrator.github.io/</p>
<p><strong>一個建立 Users Table 的 Migration 範例:</strong></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>[Migration(1)]
<span style=color:#00f>public</span> <span style=color:#00f>class</span> <span style=color:#2b91af>CreateUserTable</span> : Migration
{
    <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Up()
    {
        Create.Table(<span style=color:#a31515>&#34;Users&#34;</span>)
            .WithColumn(<span style=color:#a31515>&#34;Id&#34;</span>).AsInt32().PrimaryKey().Identity()
            .WithColumn(<span style=color:#a31515>&#34;Name&#34;</span>).AsString(255);
    }

    <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Down()
    {
        Delete.Table(<span style=color:#a31515>&#34;Users&#34;</span>);
    }
}
</code></pre></div><p>可能會有人想說「為什麼不直接用 Entity framework 就好？」，EF 提供完整的 ORM，而這個套件只提供「遷移」這部分，算是另一種選擇，如果有專案因為效能問題不想使用 EF 但又想要有類似機制，就可以使用這個套件。</p>
<h3 id=使用-migration-框架與使用-sql-的比較>使用 Migration 框架與使用 SQL 的比較</h3>
<div class=table>
<table>
<thead>
<tr>
<th></th>
<th>使用 Migration 框架</th>
<th>使用 SQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>支援不同的資料庫</td>
<td>套件有支援的都可以使用，寫一份就可以通用，且較不易出錯</td>
<td>要為每個資料庫個別去寫 SQL，需寫很多份，還要一個個去驗證執行是否正確</td>
</tr>
<tr>
<td>自動化執行</td>
<td>支援與 App 一同執行或使用 CLI 的方式</td>
<td>需自己處理</td>
</tr>
<tr>
<td>執行順序</td>
<td>可自訂每個 Migration 的版本，會照版本依序執行</td>
<td>無</td>
</tr>
<tr>
<td>紀錄</td>
<td>執行的紀錄將紀錄在 DB 某個 Table 中</td>
<td>無</td>
</tr>
<tr>
<td>Rollback</td>
<td>可 Rollback 到任意版本</td>
<td>需自己另外寫一份 SQL</td>
</tr>
</tbody>
</table>
</div>
<h2 id=安裝-fluent-migrator>安裝 Fluent Migrator</h2>
<p>這個套件有把執行跟寫分開，依照自己需求安裝就可以了，像是如果是要用 CLI 去執行的就可以只安裝寫 Migrations 的部分就好。</p>
<ul>
<li>純寫 Migrations 需安裝:
<ul>
<li><code>FluentMigrator</code></li>
</ul>
</li>
<li>有要執行 Migrations 需安裝:
<ul>
<li><code>FluentMigrator.Runner</code></li>
<li>目標資料庫的 <a href=http://ADO.NET>ADO.NET</a> Data Provider
<ul>
<li>SQLite: <code>Microsoft.Data.Sqlite</code></li>
<li>PostgreSQL: <code>Npgsql</code></li>
<li>&mldr;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id=撰寫-migration>撰寫 Migration</h2>
<p>建立一個名為 <code>20200616_CreateUserTable</code> 的檔案，在裡面寫一個 Class，他繼承 <code>Migration</code> 及實作 <code>Up()</code> 跟 <code>Down()</code> 兩個方法。</p>
<blockquote>
<p>檔名跟 Class 名稱不限制，但建議檔名前面版本，便於檢視。</p>
</blockquote>
<p>接下來為這個 Class 加上 <code>[Migration]</code> Attribute，如 <code>[Migration(&lt;自訂版本>)]</code>，版本可自訂，用於決定執行順序。</p>
<blockquote>
<p>FluentMigrator 會依照這個版本號由小到大去執行。</p>
</blockquote>
<p>在 <code>Up()</code> 中攥寫這個 Migration 要執行的動作，而 <code>Down()</code> 則是寫 <code>Up()</code> 反向的操作，是用來清除 <code>Up()</code> 所執行的效果。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>[Migration(1)]
<span style=color:#00f>public</span> <span style=color:#00f>class</span> <span style=color:#2b91af>CreateUserTable</span>: Migration
{
    <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Up()
    {
        <span style=color:green>// ...
</span><span style=color:green></span>    }

    <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Down()
    {
        <span style=color:green>// ...
</span><span style=color:green></span>    }
}
</code></pre></div><p>這個套件提供使用 Fluent Interface 的方式去定義要執行的操作 (如建表、修改欄位&mldr;等)，幾乎可以不需要看文件就可以依照 IDE 提示寫出來。</p>
<div class=image>
<figure class=figure>
<img src=https://blog.puckwang.com/images/2020/fluent-migrator-interface-demo.gif class="figure-img img-fluid rounded" alt="展示建立 Table" width=500>
<figcaption class="figure-caption text-center">展示建立 Table</figcaption>
</figure>
</div>
<p>假設我要建立帶有 id 及 name 欄位的 users 資料表，那我可以這樣寫：</p>
<ul>
<li>在 <code>Up()</code> 中，使用 <code>Create</code> 去建立一個名為 users 的資料表，接下來使用 <code>WithColumn</code> 去定義兩個欄位。</li>
<li>在 <code>Down()</code> 中，使用 <code>Delete</code> 去刪除這個資料表。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    [Migration(1)]
    <span style=color:#00f>public</span> <span style=color:#00f>class</span> <span style=color:#2b91af>CreateUserTable</span>: Migration
    {
        <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Up()
        {
            Create.Table(<span style=color:#a31515>&#34;users&#34;</span>)
                .WithColumn(<span style=color:#a31515>&#34;id&#34;</span>).AsInt32().PrimaryKey().Identity()
                .WithColumn(<span style=color:#a31515>&#34;name&#34;</span>).AsString();
        }
        
        <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Down()
        {
            Delete.Table(<span style=color:#a31515>&#34;users&#34;</span>);
        }
    }
</code></pre></div><blockquote>
<p>一個 Migration 沒有限制只能做一件事，像是我可以一個 Migrstion 就建很多個資料表。</p>
</blockquote>
<h3 id=fluent-interface-支援的操作>Fluent Interface 支援的操作</h3>
<p>它命名的非常直覺，幾乎可以不用看文件直接照著打就可以完成。詳細也可參考 <a href=https://fluentmigrator.github.io/articles/technical/fluent-api.html>Fluent Syntax Schema Overview</a>。</p>
<p>支援的操作及範例如下：</p>
<h4 id=建立>建立</h4>
<ul>
<li>進入點: <code>Create</code></li>
<li>用途: 用於 <strong>建立</strong> 資料表、欄位、Index、Unique 約束&mldr;</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>Create.Table(<span style=color:#a31515>&#34;users&#34;</span>)
    .WithColumn(<span style=color:#a31515>&#34;id&#34;</span>).AsInt32().PrimaryKey().Identity()
    .WithColumn(<span style=color:#a31515>&#34;name&#34;</span>).AsString();
</code></pre></div><h4 id=編輯>編輯</h4>
<ul>
<li>進入點: <code>Alter</code></li>
<li>用途: 用於 <strong>編輯</strong> 資料表、欄位、Index、Unique 約束&mldr;</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>Alter.Table(<span style=color:#a31515>&#34;users&#34;</span>).AddColumn(<span style=color:#a31515>&#34;account&#34;</span>).AsString().Unique();
</code></pre></div><h4 id=改名>改名</h4>
<ul>
<li>進入點: <code>Rename</code></li>
<li>用途: 用於 <strong>重新命名</strong> 資料表、欄位、Index、Unique 約束&mldr;</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:green>// 將 users 改為 accounts
</span><span style=color:green></span>Rename.Table(<span style=color:#a31515>&#34;users&#34;</span>).To(<span style=color:#a31515>&#34;accounts&#34;</span>);

<span style=color:green>// 將 users.name 改為 users.fullname
</span><span style=color:green></span>Rename.Column(<span style=color:#a31515>&#34;name&#34;</span>).OnTable(<span style=color:#a31515>&#34;users&#34;</span>).To(<span style=color:#a31515>&#34;fullname&#34;</span>);
</code></pre></div><h4 id=刪除>刪除</h4>
<ul>
<li>進入點: <code>Delete</code></li>
<li>用途: 用於 <strong>刪除</strong> 資料表、欄位，資料、Index、Unique 約束&mldr;</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    <span style=color:green>// 刪除資料表
</span><span style=color:green></span>    Delete.Table(<span style=color:#a31515>&#34;users&#34;</span>);
    
    <span style=color:green>// 刪除欄位
</span><span style=color:green></span>    Delete.Column(<span style=color:#a31515>&#34;column1&#34;</span>)
        .Column(<span style=color:#a31515>&#34;column2&#34;</span>)
        .FromTable(<span style=color:#a31515>&#34;users&#34;</span>);
    
    <span style=color:green>// 刪除資料
</span><span style=color:green></span>    Delete.FromTable(<span style=color:#a31515>&#34;users&#34;</span>)
        .Row(<span style=color:#00f>new</span> { name = <span style=color:#a31515>&#34;Admin&#34;</span> }); <span style=color:green>// 刪除 name = &#39;Admin&#39; 的 rows
</span></code></pre></div><h4 id=新增資料>新增資料</h4>
<ul>
<li>進入點: <code>Insert</code></li>
<li>用途: 用於新增資料</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    Insert
        .IntoTable(<span style=color:#a31515>&#34;users&#34;</span>)
        .Row(<span style=color:#00f>new</span> { name = <span style=color:#a31515>&#34;Admin&#34;</span> });
</code></pre></div><h4 id=更新資料>更新資料</h4>
<ul>
<li>進入點: <code>Update</code></li>
<li>用途: 用於更新資料</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    Update.Table(<span style=color:#a31515>&#34;users&#34;</span>)
        .Set(<span style=color:#00f>new</span> { name = <span style=color:#a31515>&#34;Administrator&#34;</span> })
        .Where(<span style=color:#00f>new</span> { name = <span style=color:#a31515>&#34;Admin&#34;</span> });
</code></pre></div><h4 id=執行-sql>執行 SQL</h4>
<ul>
<li>進入點: <code>Execute</code></li>
<li>用途: 用於執行原生 SQL</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    Execute.Script(<span style=color:#a31515>&#34;myscript.sql&#34;</span>);
    Execute.EmbeddedScript(<span style=color:#a31515>&#34;UpdateLegacySP.sql&#34;</span>);
    Execute.Sql(<span style=color:#a31515>&#34;DELETE TABLE users&#34;</span>);
</code></pre></div><h4 id=判斷資料庫類型>判斷資料庫類型</h4>
<ul>
<li>進入點: <code>IfDatabase()</code></li>
<li>用途: 當有些操作只想要在特定資料庫類型執行時，就可以用它來判斷。
<ul>
<li>資料庫 <a href=https://fluentmigrator.github.io/articles/multi-db-support.html#supported-databases>識別碼</a>。</li>
</ul>
</li>
<li>範例:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    <span style=color:green>// 只在 PostgreSQL 才建立 users
</span><span style=color:green></span>    IfDatabase(<span style=color:#a31515>&#34;Postgres&#34;</span>)
        .Create.Table(<span style=color:#a31515>&#34;users&#34;</span>)
        .WithColumn(<span style=color:#a31515>&#34;id&#34;</span>).AsInt32().PrimaryKey().Identity()
        .WithColumn(<span style=color:#a31515>&#34;name&#34;</span>).AsString();
</code></pre></div><h2 id=執行-migration>執行 Migration</h2>
<p>執行的方式有提兩種供選擇，分別為 In-Process 與 CLI，如果沒有特殊需求，官方推薦是使用 In-Process 的方式執行 Migrations。</p>
<h3 id=in-process>In-Process</h3>
<p>顧名思義就是跟主程式包再一起，以下是我把把官方的範例程式化簡後的樣子，主要就分為「設定服務」及「執行」兩部分而已，可以依照自己需求加到自己的專案中。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:green>// 設定 DI 服務
</span><span style=color:green></span><span style=color:#2b91af>var</span> serviceProvider = <span style=color:#00f>new</span> ServiceCollection()
                        .AddFluentMigratorCore()
                        .ConfigureRunner(rb =&gt; rb
                            .AddSQLite()
                            .WithGlobalConnectionString(<span style=color:#a31515>&#34;Data Source=test.db&#34;</span>)
                            .ScanIn(<span style=color:#00f>typeof</span>(AddLogTable).Assembly).For.Migrations())
                        .AddLogging(lb =&gt; lb.AddFluentMigratorConsole())
                        .BuildServiceProvider(<span style=color:#00f>false</span>);

<span style=color:green>// 取得 Runner
</span><span style=color:green></span><span style=color:#2b91af>var</span> runner = serviceProvider.GetRequiredService&lt;IMigrationRunner&gt;();

<span style=color:green>// 執行 Migrations
</span><span style=color:green></span>runner.MigrateUp();
</code></pre></div><p>以 .Net Core Web App 為例，就可以放在 <code>Startup.cs</code> 裡面，直接用它所提供的 <code>ServiceCollection</code> 去設定服務，就像這樣：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=color:#00f>public</span> <span style=color:#00f>class</span> <span style=color:#2b91af>Startup</span>
{

    <span style=color:#00f>public</span> <span style=color:#00f>void</span> ConfigureServices(IServiceCollection services)
    {
        services.AddFluentMigratorCore()
                .ConfigureRunner(rb =&gt; rb
                    .AddSQLite()
                    .WithGlobalConnectionString(<span style=color:#a31515>&#34;Data Source=test.db&#34;</span>)
                    .ScanIn(<span style=color:#00f>typeof</span>(AddLogTable).Assembly).For.Migrations())
    }

    <span style=color:#00f>public</span> <span style=color:#00f>void</span> Configure(IApplicationBuilder app, IMigrationRunner migrationRunner)
    {
        migrationRunner.MigrateUp();
    }
}
</code></pre></div><p>也是可以直接在 <code>Program.cs</code> 中執行，視自己需求決定。</p>
<h3 id=cli>CLI</h3>
<p>官方有提供 Command Line 的工具 <code>FluentMigrator.DotNet.Cli</code>，可以藉由他直接執行含有 Migrations 的 dll。</p>
<p><a href=https://fluentmigrator.github.io/articles/runners/dotnet-fm.html>官方文件</a></p>
<p>安裝 <code>FluentMigrator.DotNet.Cli</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>dotnet tool install -g FluentMigrator.DotNet.Cli
</code></pre></div><p>安裝完後，就可以藉由執行 <code>dotnet fm</code> 來完成一些事。</p>
<p>執行 <code>dotnet fm -h</code> 叫出 help 就可以看到有哪些功能，沒有很複雜。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; dotnet fm -h
The external FluentMigrator runner that integrates into the .NET Core CLI tooling

Usage: dotnet-fm [options] [command]

Options:
  -?|-h|--help  Execute FluentMigrator actions

Commands:
  list          List stuff
  migrate       Apply migrations
  rollback      Rollback last migration
  validate      Validations
</code></pre></div><p>執行 Migration 是 <code>dotnet fm migrate</code>，完整指令如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>dotnet fm migrate -p sqlite -c <span style=color:#a31515>&#34;Data Source=test.db&#34;</span> -a <span style=color:#a31515>&#34;.\bin\Debug\netcoreapp2.1\test.dll&#34;</span>
</code></pre></div><ul>
<li><code>-p</code>: Processor 類型，可以執行 <code>dotnet fm list processors</code> 查看所有的類型。</li>
<li><code>-c</code>: 連線字串</li>
<li><code>-a</code>: Assembly (dll)，裡面要包含寫好的 Migrations。</li>
</ul>
<h3 id=執行結果>執行結果</h3>
<p>兩種方式執行結果是一樣的，就是會顯示執行過的 Migration 及執行資訊，並會在 DB 建一個 Table (預設名稱為：VersionInfo) 去紀錄，範例如下。</p>
<table>
<thead>
<tr>
<th style=text-align:left>Version</th>
<th style=text-align:left>AppliedOn</th>
<th style=text-align:left>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style=text-align:left>20191114100000</td>
<td style=text-align:left>2020-06-20 12:00:28.000000</td>
<td style=text-align:left>InitDB</td>
</tr>
<tr>
<td style=text-align:left>20191115110000</td>
<td style=text-align:left>2020-06-20 12:00:28.000000</td>
<td style=text-align:left>AddUsersTable</td>
</tr>
<tr>
<td style=text-align:left>20191125100000</td>
<td style=text-align:left>2020-06-20 12:00:28.000000</td>
<td style=text-align:left>AddRolesTable</td>
</tr>
<tr>
<td style=text-align:left>20191128100000</td>
<td style=text-align:left>2020-06-20 12:00:28.000000</td>
<td style=text-align:left>AddPostsTable</td>
</tr>
</tbody>
</table>
<h2 id=其他功能>其他功能</h2>
<h3 id=自動撤銷-migrations>自動撤銷 Migrations</h3>
<p>寫久了，如果遇到一次要做很多事情，但又不想相似的東西要寫 <code>Up</code> 及 <code>Down</code> 兩次，就可以改繼承 <code>AutoReversingMigration</code>，
之後一些單純的操作 (如建表&mldr;) 就不用寫 <code>Down()</code> 的部分，不過如果在使用上遇到某些方法找不到，就代表他是不支援的，就不能用 <code>AutoReversingMigration</code> 了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs>    [Migration(1)]
    <span style=color:#00f>public</span> <span style=color:#00f>class</span> <span style=color:#2b91af>CreateUserTable</span>: AutoReversingMigration
    {
        <span style=color:#00f>public</span> <span style=color:#00f>override</span> <span style=color:#00f>void</span> Up()
        {
            Create.Table(<span style=color:#a31515>&#34;users&#34;</span>)
                .WithColumn(<span style=color:#a31515>&#34;id&#34;</span>).AsInt32().PrimaryKey().Identity()
                .WithColumn(<span style=color:#a31515>&#34;name&#34;</span>).AsString();
        }
    }
</code></pre></div><blockquote>
<p>它是如何實現只要正常的操作也可以達成 Rollback 功能？
之前我有去翻他的 Source Code，他底層有套 Command Pattern 去解決。</p>
</blockquote>
<div>
<br>
<h3>
感謝閱讀！
</h3>
<div>
喜歡這篇文章或是有幫助到你嗎？ 歡迎分享給你的朋友！
</div>
<br>
<div>
有任何問題、回饋或您認為我會感興趣的任何東西嗎？ 請在下面發表評論，或者是<a href=https://blog.puckwang.com/about target=_blank>直接聯絡我</a>。
</div>
<br>
</div>
<div class="share-icons d-flex justify-content-center d-print-none">
<a href="https://twitter.com/intent/tweet?url=https%3a%2f%2fblog.puckwang.com%2fposts%2f2020%2fdotcore-use-fluentmigrator%2f&text=.Net%20Core%20%e4%bd%bf%e7%94%a8%20FluentMigrator%20%e9%81%b7%e7%a7%bb%e8%b3%87%e6%96%99%e5%ba%ab&tw_p=tweetbutton" class=p-2 title="Share on Twitter" target=_blank rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Tweet</small></div>
</a>
<a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.puckwang.com%2fposts%2f2020%2fdotcore-use-fluentmigrator%2f&t=.Net%20Core%20%e4%bd%bf%e7%94%a8%20FluentMigrator%20%e9%81%b7%e7%a7%bb%e8%b3%87%e6%96%99%e5%ba%ab" class=p-2 title="Share on Facebook" target=_blank rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Share</small></div>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.puckwang.com%2fposts%2f2020%2fdotcore-use-fluentmigrator%2f&title=.Net%20Core%20%e4%bd%bf%e7%94%a8%20FluentMigrator%20%e9%81%b7%e7%a7%bb%e8%b3%87%e6%96%99%e5%ba%ab&source=mattbutton.com" class=p-2 title="Share on LinkedIn" target=_blank rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Share</small></div>
</a>
<a href=javascript:window.print() title="Print this article" class=p-2 rel=nofollow>
<div>
<span class=fa-stack>
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fa fa-print fa-stack-1x fa-inverse"></i>
</span>
</div>
<div class="fa-inverse text-center"><small>Print</small></div>
</a>
</div>
<div>
<hr>
<div class="p-4 row justify-content-center" style=align-items:center>
<div class=col-2>
<img src=https://blog.puckwang.com/images/author.jpg alt="Puck Wang" class="img-fluid rounded-circle" width=150>
</div>
<div class=col-8 style=vertical-align:middle>
<h4>
Puck Wang
</h4>
<p>
Hi！ 我是 Puck Wang，這個部落格的作者，是一位全端網站開發者，常使用 .Net 和 React 進行開發，專注於架構研究，你可以在這個部落格看到我精選的筆記內容，希望對你會有所幫助。
</p>
<p>
更多關於我的訊息，可至關於<a href=https://blog.puckwang.com/about target=_blank>關於</a>頁面。
</p>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//www.facebook.com/puckwang14><i class="fab fa-facebook-square"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//twitter.com/puckwang14><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//github.com/puckwang><i class="fab fa-github"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//linkedin.com/in/puckwang><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href="//stackoverflow.com/users/7699156/puckwang?tab=profile"><i class="fab fa-stack-overflow"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//g.dev/puckwang><i class="fab fa-google"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=https://blog.puckwang.com/index.xml><i class="fas fa-rss"></i></a>
</div>
</div>
</div>
</div>
</div>
<div class="sidebar d-print-none d-none d-xl-block">
<div id=toc>
<h2>目錄</h2>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#使用-migration-框架與使用-sql-的比較>使用 Migration 框架與使用 SQL 的比較</a></li>
</ul>
</li>
<li><a href=#安裝-fluent-migrator>安裝 Fluent Migrator</a></li>
<li><a href=#撰寫-migration>撰寫 Migration</a>
<ul>
<li><a href=#fluent-interface-支援的操作>Fluent Interface 支援的操作</a></li>
</ul>
</li>
<li><a href=#執行-migration>執行 Migration</a>
<ul>
<li><a href=#in-process>In-Process</a></li>
<li><a href=#cli>CLI</a></li>
<li><a href=#執行結果>執行結果</a></li>
</ul>
</li>
<li><a href=#其他功能>其他功能</a>
<ul>
<li><a href=#自動撤銷-migrations>自動撤銷 Migrations</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
</div>
<footer class="mt-auto footer d-print-none">
<div class=container-fluid>
<div class="row justify-content-center">
<div class="col-md-4 col-xl-3">
<h5>Copyright © 2017-2024, Puck Wang; all rights reserved.</h5>
Opinions expressed here are my own and may not reflect those of the company I work for, or the people I work with.
</div>
<div class="col-md-4 col-xl-3">
<h5>Disclaimer</h5>
See <a href=https://blog.puckwang.com/other/disclaimer/>disclaimer</a> of <a href=https://blog.puckwang.com>https://blog.puckwang.com/</a>
</div>
<div class="col-md-4 col-xl-3">
<h5>About This Site</h5>
This blog was created using the <a href=https://gohugo.io/>Hugo</a> static site generator, using
<a href=https://getbootstrap.com/>Bootstrap</a>, using the Silhouette Hugo theme, created by
<a href=https://www.mattbutton.com>Matt Button</a>
</div>
</div>
<hr>
<div class="d-flex justify-content-center icons">
<a class="py-2 px-2 d-none d-lg-inline-block" href=//www.facebook.com/puckwang14><i class="fab fa-facebook-square"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//twitter.com/puckwang14><i class="fab fa-twitter"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//github.com/puckwang><i class="fab fa-github"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//linkedin.com/in/puckwang><i class="fab fa-linkedin"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href="//stackoverflow.com/users/7699156/puckwang?tab=profile"><i class="fab fa-stack-overflow"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=//g.dev/puckwang><i class="fab fa-google"></i></a>
<a class="py-2 px-2 d-none d-lg-inline-block" href=https://blog.puckwang.com/index.xml><i class="fas fa-rss"></i></a>
</div>
</div>
</footer>
<script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script>
<script src=https://unpkg.com/mermaid@8.13.5/dist/mermaid.min.js></script>
</body>
<style>.zoom-in-thumbnail{visibility:hidden;position:fixed;z-index:100000;box-sizing:border-box;border:5px solid #fff;border-radius:3px;box-shadow:0 0 2px rgba(0,0,0,.8);opacity:0;pointer-events:none;transition-duration:.3s;transition-delay:.1s;transition-property:opacity}.zoom-in-thumbnail-img{background-repeat:no-repeat;background-size:contain}</style>
<script>const root=document.documentElement;$(function(){mermaid.initialize({startOnLoad:!0}),$(".main-content img, .post img").each(function(){this.complete?generateImageDiv(this):$(this).on("load",function(){generateImageDiv(this)}),this.style.cursor="pointer",$(this).on("mousemove",function(d){let b=d.clientX,c=d.clientY,a;$(this).next().width()>=$(this).next().height()?innerHeight-c<=$(this).next().height()+50?a=getShowXY(this,"top",b,c):a=getShowXY(this,"bottom",b,c):innerWidth-b<=$(this).next().width()+50?a=getShowXY(this,"left",b,c):a=getShowXY(this,"right",b,c),root.style.setProperty("--zoom-image-x",a.x+250+"px"),root.style.setProperty("--zoom-image-y",a.y+"px")}),$(this).on("click",function(a){window.open(this.src)})})});function getShowXY(d,e,a,b){let c=$(d).next();switch(e){case'top':a-=c.width()/2,b-=c.height(),b-=25;break;case'bottom':a-=c.width()/2,b+=25;break;case'right':b-=c.height()/2,a+=25;break;case'left':a-=c.width(),b-=c.height()/2,a-=25;break}return{x:a,y:b}}function generateImageDiv(c){var e=screen.width*.6,f=screen.height*.5,d=0,a=c.naturalHeight,b=c.naturalWidth,g;b>e&&(d=e/b,b=e,a=a*d),a>f&&(d=f/a,a=f,b=b*d),g="<div class='zoom-in-thumbnail'><div class='zoom-in-thumbnail-img' style=\"background-color: white; background-image:url('"+c.src+"'); height: "+a+"px; width: "+b+'px;"></div></div>',$(c).after(g)}</script>
</html>